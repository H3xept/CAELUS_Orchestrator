openapi: 3.0.0
info:
  version: 1.0.0
  title: CAELUS Digital Twin
  description: An interface to the Digital Twin simulation package running on some cluster.

paths:
  /login:
    post:
      tags:
        - Authentication
      description: Login for an existing user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: Successful login -- JWT token is provided along with expiry.
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    example: eyJ0eXAiOiJ...oQHfTjaqiT01JUpk_y0C46Mns
                  expires:
                    type: string
                    example: Wed, 01 Dec 2021 17:48:50 GMT
        '401':
          description: Authentication failed -- Wrong credentials / User not registered.
          
  /register:
    post:
      tags:
        - Authentication
      description: Register a new user. Only the user with username "admin" can use this endpoint.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: Successful registration. Proceed with login.
        '400':
          description: Registration failed. An user with the same username already exists.
  /new_mission:
    post:
      tags:
        - Simulation
      description: Create a new mission for the logged in account.
      requestBody:
        required: true
        description: The body of this request should contain the JSON file with the information required by the simulator.
        content:
            application/json:
              schema:
                type: object
                example: {
                  "waypoints": [
                    [
                      -5.130347001,
                      55.573712,
                      76.34867418469977
                    ],
                    [
                      -5.127004941287092,
                      55.56680838912485,
                      91.58793050899115
                    ],
                    [
                      -5.123662806694234,
                      55.55990485003062,
                      134.41024078024992
                    ],
                    [
                      -4.346594476,
                      55.856459795,
                      34.135934166412675
                    ]
                  ],
                  "operation_id": "d40a18aa-6151-4593-8d30-44cdd3e97d36",
                  "control_area_id": "2eee4ddf-b230-4be1-aee0-0a827e818fa5",
                  "operation_reference_number": "443ba31f-ee3b-4abd-8eaa-d73cfad9f6c9",
                  "drone_id": "c1ccc111-0647-4c4d-b93e-91bd740bb87d",
                  "drone_registration_number": "5c17c4d2-e878-4a47-a6a3-724f16f46ba2",
                  "dis_auth_token": "Bearer eyJ0eXAiOiJ...oQHfTjaqiT01JUpk_y0C46Mns",
                  "thermal_model_timestep": 0.004,
                  "aeroacoustic_model_timestep": 0.004,
                  "drone_config": {},
                  "g_acceleration": 9.81,
                  "effective_start_time": 1638526876,
                  "initial_lon_lat_alt": [
                    -5.130347001,
                    55.573712,
                    46.1
                  ],
                  "final_lon_lat_alt": [
                    -4.346594476,
                    55.856459795,
                    34.135934166412675
                  ]
                }
                
      responses:
        '200':
          description: Successful job creation
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                    example: eyJ0eXAiOiJ...oQHfTjaqiT01JUpk_y0C46Mns
        '401':
          description: Not logged in
  /simulation_data/{operation_id}:
    get:
      tags:
        - Simulation
      description: Retrieves the simulation data for a given operation
      parameters:
        - in: path
          name: operation_id
          schema:
            type: string
            example: 5c17c4d2-e878-4a47-a6a3-724f16f46ba2
          required: true
          description: UUID of the operation to retrieve information about.
          
      responses:
        '200':
          description: Successfully retrieved simulation data.
          content:
            application/json:
              schema:
                type: object
                properties:
                  battery_level:
                    type: array
                    items:
                      type: number
                      format: float
                      example: [100, 99.9, 99.8]
                  payload_temperature:
                    type: array
                    items:
                      type: number
                      format: float
                      example: [5.0, 5.001, 5.002]
                  aeroacoustic:
                    type: array
                    items:
                      type: array
                      items:
                        type: number
                        format: float
                      example: [202751.4487, 635565.9294, 0, 14.58, 0.0, -0.00010678921514848534, 0.0005663992152687102, 0.9999998338939824, 0.0, -0.00010678921514848534, 0.0005663992152687102, 0.9999998338939824, 0.0, -0.00010678921514848534, 0.0005663992152687102, 0.9999998338939824, 0.0, -0.00010678921514848534, 0.0005663992152687102, 0.9999998338939824]
                  flight_time:
                    type: number
                    format: float
                    example: 419.636
                    description: in seconds
        '401':
          description: Authentication failed -- Wrong credentials / User not registered.
        '404':
          description: There is a job associated with the given operation_id but no simulation data is present. This could mean that the simulation is still running.
  /jobs:
    get:
      tags:
        - Simulation
      description: Gets all jobs associated with a user

      responses:
        '200':
          description: Successful login -- JWT token is provided along with expiry.
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      example: eyJ0eXAiOiJ...oQHfTjaqiT01JUpk_y0C46Mns
                    docker_image:
                      type: string
                      example: 'caelus_dt_0.0.1'
                    mission_payload:
                      type: object
                      example: {
                        "waypoints": [
                          [
                            -5.130347001,
                            55.573712,
                            76.34867418469977
                          ],
                          [
                            -5.127004941287092,
                            55.56680838912485,
                            91.58793050899115
                          ],
                          [
                            -5.123662806694234,
                            55.55990485003062,
                            134.41024078024992
                          ],
                          [
                            -4.346594476,
                            55.856459795,
                            34.135934166412675
                          ]
                        ],
                        "operation_id": "d40a18aa-6151-4593-8d30-44cdd3e97d36",
                        "control_area_id": "2eee4ddf-b230-4be1-aee0-0a827e818fa5",
                        "operation_reference_number": "443ba31f-ee3b-4abd-8eaa-d73cfad9f6c9",
                        "drone_id": "c1ccc111-0647-4c4d-b93e-91bd740bb87d",
                        "drone_registration_number": "5c17c4d2-e878-4a47-a6a3-724f16f46ba2",
                        "dis_auth_token": "Bearer eyJ0eXAiOiJ...oQHfTjaqiT01JUpk_y0C46Mns",
                        "thermal_model_timestep": 0.004,
                        "aeroacoustic_model_timestep": 0.004,
                        "drone_config": {},
                        "g_acceleration": 9.81,
                        "effective_start_time": 1638526876,
                        "initial_lon_lat_alt": [
                          -5.130347001,
                          55.573712,
                          46.1
                        ],
                        "final_lon_lat_alt": [
                          -4.346594476,
                          55.856459795,
                          34.135934166412675
                        ]
                      }
                    status:
                      type: number
                      enum: [0, 1, 2, 3, 4]
                    status_str:
                      type: string
                      enum: [CREATED, RUNNING, ERROR, TERMINATED, HALTED]
                    issuer_id:
                      type: string
                      example: 'admin'
        '401':
          description: Authentication failed -- Wrong credentials / User not registered.
  /halt/{pid}:
    post:
      tags:
        - Simulation
      parameters:
        - in: path
          name: pid
          schema:
            type: string
            example: 5c17c4d2-e878-4a47-a6a3-724f16f46ba2
          required: true
          description: UUID of the mission to halt
      description: Halt a mission prematurely.
      responses:
        '200':
          description: Successful termination.
        '401':
          description: Authentication failed -- Wrong credentials / User not registered / You do not own that mission.
        '400':
          description: The mission could not be terminated (Internal error or the mission is already in a terminal state)
          